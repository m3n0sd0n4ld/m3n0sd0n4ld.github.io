<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Viewer</title>
</head>
<body>
    <h1>Markdown Viewer</h1>
    <form id="decryptForm">
        <label for="password">Introduce la contraseña:</label>
        <input type="password" id="password" name="password" required>
        <button type="submit">Ver contenido</button>
    </form>
    <pre id="content" style="display: none;"></pre>
    <p id="error" style="color: red; display: none;">Contraseña incorrecta o datos corruptos</p>

    <!-- Incluir CryptoJS -->
    <script src="crypto-js.min.js"></script>
    <script>
        async function deriveKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                enc.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );
        }

        document.getElementById('decryptForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;

            fetch('test.md.enc')
                .then(response => response.arrayBuffer())
                .then(async encryptedData => {
                    const salt = new Uint8Array(encryptedData.slice(0, 16));
                    const data = new Uint8Array(encryptedData.slice(16));

                    const key = await deriveKey(password, salt);
                    
                    try {
                        const decrypted = await crypto.subtle.decrypt(
                            {
                                name: 'AES-GCM',
                                iv: new Uint8Array(12)  // AES-GCM requiere un IV de 12 bytes, pero esto debe ser consistente con el cifrado
                            },
                            key,
                            data
                        );

                        const dec = new TextDecoder();
                        const decryptedStr = dec.decode(decrypted);
                        if (decryptedStr) {
                            document.getElementById('content').textContent = decryptedStr;
                            document.getElementById('content').style.display = 'block';
                            document.getElementById('error').style.display = 'none';
                        } else {
                            throw new Error("Descifrado fallido");
                        }
                    } catch (e) {
                        document.getElementById('error').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('error').style.display = 'block';
                });
        });
    </script>
</body>
</html>
